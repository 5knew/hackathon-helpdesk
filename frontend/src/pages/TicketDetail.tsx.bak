import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Ticket, Comment, Feedback } from '../types';
import { storage } from '../utils/storage';
import { getTicket, getComments, addComment, updateTicket, submitFeedback } from '../utils/ticket';
import { showToast } from '../utils/toast';
import { Chip } from '../components/Chip';

export const TicketDetail: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [ticket, setTicket] = useState<Ticket | null>(null);
  const [comments, setComments] = useState<Comment[]>([]);
  const [newComment, setNewComment] = useState('');
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedbackRating, setFeedbackRating] = useState(0);
  const [feedbackComment, setFeedbackComment] = useState('');

  useEffect(() => {
    if (!storage.isLogged()) {
      navigate('/');
      return;
    }
    if (id) {
      loadTicket();
      loadComments();
    }
  }, [id, navigate]);

  const loadTicket = async () => {
    if (!id) return;
    setLoading(true);
    try {
      const data = await getTicket(parseInt(id));
      setTicket(data);
      if (data.status === 'Closed' && !showFeedback) {
        // Check if feedback already submitted
        setShowFeedback(true);
      }
    } catch (error) {
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–∏–∫–µ—Ç–∞', 'error');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const loadComments = async () => {
    if (!id) return;
    try {
      const data = await getComments(parseInt(id));
      setComments(data);
    } catch (error) {
      console.error('Error loading comments:', error);
    }
  };

  const handleAddComment = async () => {
    if (!newComment.trim() || !id) return;
    setSubmitting(true);
    try {
      await addComment(parseInt(id), newComment, false);
      setNewComment('');
      await loadComments();
      showToast('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
    } catch (error) {
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
      console.error(error);
    } finally {
      setSubmitting(false);
    }
  };

  const handleUpdateStatus = async (newStatus: string) => {
    if (!id) return;
    setSubmitting(true);
    try {
      await updateTicket(parseInt(id), newStatus);
      await loadTicket();
      showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
    } catch (error) {
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
      console.error(error);
    } finally {
      setSubmitting(false);
    }
  };

  const handleSubmitFeedback = async () => {
    if (!id || feedbackRating === 0) return;
    setSubmitting(true);
    try {
      await submitFeedback(parseInt(id), feedbackRating, feedbackComment);
      showToast('–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å!', 'success');
      setShowFeedback(false);
    } catch (error) {
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞', 'error');
      console.error(error);
    } finally {
      setSubmitting(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'Closed': return '#10b981';
      case 'Pending': return '#f59e0b';
      case 'In Progress': return '#3b82f6';
      default: return '#6b7280';
    }
  };

  if (loading) {
    return (
      <div className="page-shell">
        <div className="card glass" style={{ textAlign: 'center', padding: '3rem' }}>
          <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );
  }

  if (!ticket) {
    return (
      <div className="page-shell">
        <div className="card glass" style={{ textAlign: 'center', padding: '3rem' }}>
          <p>–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
          <button onClick={() => navigate('/my-tickets')} className="btn primary" style={{ marginTop: '1rem' }}>
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞—è–≤–∫–∞–º
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="page-shell">
      <header className="topbar card glass">
        <div className="brand">
          <div className="logo-dot"></div>
          <div>
            <p className="brand-name">–¢–∏–∫–µ—Ç #{ticket.id}</p>
            <span className="brand-sub">{ticket.subject || '–ë–µ–∑ —Ç–µ–º—ã'}</span>
          </div>
        </div>
        <button onClick={() => navigate('/my-tickets')} className="btn ghost">
          –ù–∞–∑–∞–¥
        </button>
      </header>

      <div className="content-area">
        <div className="card glass" style={{ marginBottom: '1.5rem' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
            <div>
              <h2 style={{ margin: 0, marginBottom: '0.5rem' }}>{ticket.subject || '–ë–µ–∑ —Ç–µ–º—ã'}</h2>
              <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', marginBottom: '1rem' }}>
                <Chip label={ticket.status} style={{ background: getStatusColor(ticket.status) }} />
                <Chip label={ticket.priority} />
                <Chip label={ticket.category} />
                <Chip label={ticket.queue} />
              </div>
            </div>
            {ticket.status !== 'Closed' && (
              <div style={{ display: 'flex', gap: '0.5rem' }}>
                <button
                  onClick={() => handleUpdateStatus('In Progress')}
                  className="btn primary"
                  disabled={submitting}
                >
                  –í —Ä–∞–±–æ—Ç—É
                </button>
                <button
                  onClick={() => handleUpdateStatus('Closed')}
                  className="btn"
                  disabled={submitting}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </button>
              </div>
            )}
          </div>

          <div style={{ marginBottom: '1rem' }}>
            <h3>–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</h3>
            <p style={{ whiteSpace: 'pre-wrap', lineHeight: '1.6' }}>{ticket.problem_description}</p>
          </div>

          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', fontSize: '0.9rem' }}>
            {ticket.created_at && (
              <div>
                <strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {new Date(ticket.created_at).toLocaleString('ru-RU')}
              </div>
            )}
            {ticket.updated_at && (
              <div>
                <strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> {new Date(ticket.updated_at).toLocaleString('ru-RU')}
              </div>
            )}
            {ticket.sla_deadline && (
              <div>
                <strong>SLA –¥–µ–¥–ª–∞–π–Ω:</strong> {new Date(ticket.sla_deadline).toLocaleString('ru-RU')}
              </div>
            )}
            {ticket.sla_status && (
              <div>
                <strong>SLA —Å—Ç–∞—Ç—É—Å:</strong> {ticket.sla_status}
              </div>
            )}
          </div>

          {ticket.needs_clarification && (
            <div style={{
              marginTop: '1rem',
              padding: '1rem',
              background: 'rgba(239, 68, 68, 0.1)',
              borderRadius: '8px',
              border: '1px solid rgba(239, 68, 68, 0.3)'
            }}>
              <strong>‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏–µ:</strong> {ticket.confidence_warning}
            </div>
          )}
        </div>

        <div className="card glass" style={{ marginBottom: '1.5rem' }}>
          <h3 style={{ marginTop: 0 }}>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({comments.length})</h3>
          <div style={{ marginBottom: '1rem' }}>
            {comments.map((comment) => (
              <div
                key={comment.id}
                style={{
                  padding: '1rem',
                  marginBottom: '0.5rem',
                  background: comment.is_auto_reply ? 'rgba(59, 130, 246, 0.1)' : 'rgba(255,255,255,0.05)',
                  borderRadius: '8px',
                  borderLeft: `3px solid ${comment.is_auto_reply ? '#3b82f6' : '#10b981'}`
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                  <strong>{comment.is_auto_reply ? 'ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç' : `üë§ ${comment.user_id}`}</strong>
                  <span style={{ fontSize: '0.85rem', opacity: 0.7 }}>
                    {new Date(comment.created_at).toLocaleString('ru-RU')}
                  </span>
                </div>
                <p style={{ margin: 0, whiteSpace: 'pre-wrap' }}>{comment.comment_text}</p>
              </div>
            ))}
          </div>

          <div style={{ display: 'flex', gap: '0.5rem' }}>
            <textarea
              value={newComment}
              onChange={(e) => setNewComment(e.target.value)}
              placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
              style={{
                flex: 1,
                padding: '0.75rem',
                borderRadius: '8px',
                border: '1px solid rgba(255,255,255,0.1)',
                background: 'rgba(255,255,255,0.05)',
                color: '#fff',
                minHeight: '80px',
                resize: 'vertical'
              }}
            />
            <button
              onClick={handleAddComment}
              className="btn primary"
              disabled={submitting || !newComment.trim()}
            >
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>

        {showFeedback && ticket.status === 'Closed' && (
          <div className="card glass">
            <h3 style={{ marginTop: 0 }}>–û—Ü–µ–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h3>
            <div style={{ marginBottom: '1rem' }}>
              <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                {[1, 2, 3, 4, 5].map((rating) => (
                  <button
                    key={rating}
                    onClick={() => setFeedbackRating(rating)}
                    style={{
                      width: '50px',
                      height: '50px',
                      borderRadius: '50%',
                      border: '2px solid',
                      background: feedbackRating >= rating ? '#f59e0b' : 'transparent',
                      color: '#fff',
                      fontSize: '1.5rem',
                      cursor: 'pointer'
                    }}
                  >
                    ‚≠ê
                  </button>
                ))}
              </div>
              <textarea
                value={feedbackComment}
                onChange={(e) => setFeedbackComment(e.target.value)}
                placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..."
                style={{
                  width: '100%',
                  padding: '0.75rem',
                  borderRadius: '8px',
                  border: '1px solid rgba(255,255,255,0.1)',
                  background: 'rgba(255,255,255,0.05)',
                  color: '#fff',
                  minHeight: '80px',
                  marginBottom: '1rem'
                }}
              />
              <button
                onClick={handleSubmitFeedback}
                className="btn primary"
                disabled={submitting || feedbackRating === 0}
              >
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

