#!/usr/bin/env python3
"""
–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã ML API —Å–µ—Ä–≤–∏—Å–∞
"""

import requests
import json
from typing import Dict

BASE_URL = "http://localhost:8000"

def print_section(title: str):
    print("\n" + "=" * 60)
    print(f"  {title}")
    print("=" * 60)

def demo_health_check():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞"""
    print_section("1. –ü–†–û–í–ï–†–ö–ê –ó–î–û–†–û–í–¨–Ø –°–ï–†–í–ò–°–ê")
    response = requests.get(f"{BASE_URL}/health")
    data = response.json()
    print(json.dumps(data, indent=2, ensure_ascii=False))
    return data["status"] == "healthy"

def demo_predict(ticket: Dict[str, str], title: str):
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–∫–µ—Ç–∞"""
    print_section(f"2. –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –¢–ò–ö–ï–¢–ê: {title}")
    print(f"\nüìù –¢–µ–∫—Å—Ç —Ç–∏–∫–µ—Ç–∞:")
    print(f"   –¢–µ–º–∞: {ticket['subject']}")
    print(f"   –û–ø–∏—Å–∞–Ω–∏–µ: {ticket['body']}")
    
    response = requests.post(f"{BASE_URL}/predict", json=ticket)
    data = response.json()
    
    print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:")
    print(f"   üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {data['category']} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {data['confidence']['category']:.2%})")
    print(f"   ‚ö° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {data['priority']} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {data['confidence']['priority']:.2%})")
    print(f"   üîß –¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã: {data['problem_type']} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {data['confidence']['problem_type']:.2%})")
    
    return data

def demo_auto_reply(text: str, title: str):
    """–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞"""
    print_section(f"3. –ê–í–¢–û–û–¢–í–ï–¢: {title}")
    print(f"\nüìù –í—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å:")
    print(f"   {text}")
    
    response = requests.post(f"{BASE_URL}/auto_reply", json={"text": text})
    data = response.json()
    
    print(f"\nü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç–≤–µ—Ç:")
    print(f"   –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {data['category']}")
    print(f"   –û—Ç–≤–µ—Ç: {data['reply']}")
    
    return data

def main():
    print("\n" + "üöÄ" * 30)
    print("  –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ê–ë–û–¢–´ ML API –°–ï–†–í–ò–°–ê")
    print("üöÄ" * 30)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
    if not demo_health_check():
        print("\n‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –≥–æ—Ç–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.")
        return
    
    # –ü—Ä–∏–º–µ—Ä 1: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
    ticket1 = {
        "subject": "–ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É",
        "body": "–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–µ—á–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª –ø—Ä–∏–Ω—Ç–µ—Ä, –Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∏–ª–∞—Å—å. –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å."
    }
    result1 = demo_predict(ticket1, "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞")
    
    # –ü—Ä–∏–º–µ—Ä 2: –ë–∏–ª–ª–∏–Ω–≥
    ticket2 = {
        "subject": "–í–æ–ø—Ä–æ—Å –ø–æ –æ–ø–ª–∞—Ç–µ",
        "body": "–•–æ—á—É —É–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É —Å –º–æ–µ–≥–æ —Å—á–µ—Ç–∞ —Å–ø–∏—Å–∞–ª–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É, –∫–æ—Ç–æ—Ä—É—é —è –Ω–µ –∑–∞–∫–∞–∑—ã–≤–∞–ª. –ú–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏?"
    }
    result2 = demo_predict(ticket2, "–í–æ–ø—Ä–æ—Å –ø–æ –±–∏–ª–ª–∏–Ω–≥—É")
    
    # –ü—Ä–∏–º–µ—Ä 3: –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º—ã
    demo_auto_reply(
        "–ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–µ—á–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.",
        "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞"
    )
    
    # –ü—Ä–∏–º–µ—Ä 4: –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç –¥–ª—è –±–∏–ª–ª–∏–Ω–≥–∞
    demo_auto_reply(
        "–•–æ—á—É —É–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É —Å –º–æ–µ–≥–æ —Å—á–µ—Ç–∞ —Å–ø–∏—Å–∞–ª–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É.",
        "–í–æ–ø—Ä–æ—Å –ø–æ –±–∏–ª–ª–∏–Ω–≥—É"
    )
    
    print_section("–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
    print("\n‚úÖ –í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
    print(f"\nüì° API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: {BASE_URL}")
    print(f"üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: {BASE_URL}/docs")

if __name__ == "__main__":
    try:
        main()
    except requests.exceptions.ConnectionError:
        print("\n‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É.")
        print("   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: python3 api.py")
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")

